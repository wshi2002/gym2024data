---
title: "Wendy's file"
author: "Wendy"
date: "2023-10-31"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

```{r}
world_elites <- df_women_c %>%
  filter(competition_scope == "World")%>%
  filter(Round != "TeamFinal")%>%
  filter(Round != "TeamQual")%>%
  filter(Rank != 0) %>%
  filter(Rank <= 10)%>%
  distinct(clean_name, clean_country)

other_elites <- df_women_c %>%
  filter(competition_scope != "World")%>%
  filter(Round != "TeamFinal")%>%
  filter(Round != "TeamQual")%>%
  filter(Rank != 0) %>%
  filter(Rank <= 3)%>%
  distinct(clean_name, clean_country)


```


```{r}

all_elites <- full_join(world_elites, other_elites, by = c("clean_name", "clean_country"))

all_elites%>%
  filter(clean_country == "USA")

all_elites%>%
  group_by(clean_country)%>%
  count()%>%
  filter(n>=5)%>%
  arrange(desc(n))
```


```{r}
simulate_score_w <- function(athlete, event) {
  athlete_data <- df_women_c%>%
    filter(clean_name == athlete, Apparatus == event)
  if(nrow(athlete_data)==0){
    score = 0
    return(score)
  } else{
    scores <- athlete_data$Score
    all_scores = c()
    for (s in scores) {
      std_dev <- sd(athlete_data$Score)
      if (length(scores) == 1){
        std_dev = 0.3
        }
      samples <- rnorm(n = 30, mean = s, sd = std_dev)
      all_scores = c(all_scores, samples)
      }
    score <- sample(all_scores, size = 1)
    if (length(scores)==0){
      score = 0
      }
    return(score)
  }
}
  


simulate_score_w("Kim BUI", "VT2")


```






```{r}
set.seed(21)
event_sim_indiv <- function(event_set, dataset = all_elites, country = NA){
  all_elites_event <- dataset
  if (is.na(country) == FALSE){
    all_elites_event <- all_elites_event %>%
      filter(clean_country == country)
  }
  for (event in event_set){
    all_points = c()
    for (athlete in all_elites_event$clean_name){
      points <- simulate_score_w(athlete, event)
      all_points <- c(all_points, points)
    }
    col_name <- paste("event_", event, sep= "")
    all_elites_event[, col_name] <- all_points
    
  }
  columns_to_exclude <- c("clean_name", "clean_country")
  all_elites_event$sum_score <- rowSums(all_elites_event[, !names(all_elites_event) %in% columns_to_exclude])
  winners <- all_elites_event%>%
    arrange(desc(sum_score))%>%
    slice(1:3)
  
  all_same <- all(winners$clean_country == winners$clean_country[1])
  all_same <- TRUE
  if (all_same){
    winners <- all_elites_event%>%
    arrange(desc(sum_score))%>%
    slice(1:2, 4)
  }
  
  medal_count <- c(3,2,1)
  winners <- cbind(winners, medal_count)
  return(winners)
  
}
```

```{r}
event_sim_3(c("VT1", "VT2", "BB", "FX"), all_elites)
```

```{r}
set.seed(28)
event_sim_3(c("BB"), all_elites, "USA")
```
```{r}
women_country = c("USA", "GBR", "CAN", "CHN", "BRA", "ITA", "NED", "FRA", "JPN", "AUS", "ROU", "KOR")


```


```{r}
all_elites_c <- all_elites 

all_elites_c$clean_country <- ifelse(all_elites_c$clean_country %in% women_country, 
                                     all_elites_c$clean_country, 
                                     "Other")

all_elites_c%>%
  group_by(clean_country) %>%
  count()%>%
  arrange(desc(n))
```
```{r}
all_elites_sample <- all_elites_c %>%
  filter(clean_country != "Other") %>%
  group_by(clean_country) %>%
  sample_n(5) %>%
  ungroup()
```

```{r}
event_sim_3("FX", all_elites_sample, "USA")
```

```{r}
all_elites_sample
```
```{r}
set.seed(21)
event_sim_team <- function(event, dataset = all_elites, country){
  all_elites_event <- dataset

  all_elites_event <- all_elites_event %>%
    filter(clean_country == country)
  
  all_points = c()
  for (athlete in all_elites_event$clean_name){
    points <- simulate_score_w(athlete, event)
    all_points <- c(all_points, points)
  }
  col_name <- "sum_score"
  all_elites_event[, col_name] <- all_points
    

  winners <- all_elites_event%>%
    arrange(desc(sum_score))%>%
    slice(1:3)
  
  all_same <- all(winners$clean_country == winners$clean_country[1])
  all_same <- TRUE
  if (all_same){
    winners <- all_elites_event%>%
    arrange(desc(sum_score))%>%
    slice(1:2, 4)
  }
  
  winners$apparatus <- rep(event, nrow(winners))
  return(winners)
  
}

```


```{r}
apparatuses_w = c("BB", "FX", "UB", "VT")
top_athletes <- data.frame(clean_country = character(),apparatus = character(), clean_name = character(), sum_score = numeric())
```

```{r}
for (country in women_country) {
  for (apparatus in apparatuses_w){
    top3 <- event_sim_team(apparatus, all_elites_sample, country)
    top_athletes <- rbind(top_athletes, top3)
  }
 
}


```

```{r}
top_athletes
```
```{r}
set.seed(21)
event_sim <- function(event, dataset = all_elites){
  all_elites_event <- dataset
  
  all_points = c()
  for (athlete in all_elites_event$clean_name){
    points <- simulate_score_w(athlete, event)
    all_points <- c(all_points, points)
  }
  col_name <- "sum_score"
  all_elites_event[, col_name] <- all_points
  return(all_elites_event)
  
}
```


```{r}

total_scores <- data.frame(clean_country = character(), sum_score = numeric())
print(total_scores)



for (app in apparatuses_w){
  
  subset <- top_athletes[top_athletes$apparatus == app,] %>%
    select(-c(sum_score))
  #print(subset)
  
  event_df <- event_sim(app, subset)
  #print(event_df)
  
  total_scores <- rbind(total_scores, event_df)

}

total_scores %>% 
  group_by(clean_country) %>%
  mutate(final_scores = sum(sum_score))%>%
  distinct(clean_country, final_scores)%>%
  arrange(desc(final_scores))

```

```{r}
total_scores
```

